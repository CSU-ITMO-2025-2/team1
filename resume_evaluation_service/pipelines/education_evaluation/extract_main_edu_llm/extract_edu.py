"""
–§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ —É—Ä–æ–≤–Ω—è –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è —Å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –≤—ã–≤–æ–¥–æ–º
—Å –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã
"""

import asyncio
import sys
from typing import Optional

from langchain_core.messages import BaseMessage

from ....utils.create_llm_with_retries import get_structured_llm
from ....utils.logger import setup_logger
from ..prompts.extract_main_edu.extract_main_edu_prompt_builder import (
    extract_main_edu_full_prompt,
)
from ..pydantic_models.extract_main_edu import (
    EducationList,
)

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
logger = setup_logger(__name__)

# –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫
MAX_ATTEMPTS = 10


async def extract_main_edu_llm(text: str, text_type: str) -> Optional[EducationList]:
    """
    –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –∏–∑–≤–ª–µ–∫–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–∏ (—É—Ä–æ–≤–µ–Ω—å –∏ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é)
    –∏–∑ —Ç–µ–∫—Å—Ç–∞ (—Ä–µ–∑—é–º–µ –∏–ª–∏ –≤–∞–∫–∞–Ω—Å–∏–∏) —Å –ø–æ–º–æ—â—å—é LLM –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞.

    –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –º–æ–¥–µ–ª–∏ –ø–ª–∞–≤–Ω–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è —Å –∫–∞–∂–¥–æ–π –ø–æ–ø—ã—Ç–∫–æ–π, —á—Ç–æ–±—ã –ø–æ–≤—ã—Å–∏—Ç—å
    –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑-–∑–∞ "–≥—Ä—è–∑–Ω—ã—Ö" —Å–∏–º–≤–æ–ª–æ–≤).

    Args:
        text (str): –¢–µ–∫—Å—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.
        text_type (str): –¢–∏–ø —Ç–µ–∫—Å—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–≤–∞–∫–∞–Ω—Å–∏–∏", "—Ä–µ–∑—é–º–µ") ‚Äî –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è.

    Returns:
        Optional[EsucationList]: –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç —Å —É—Ä–æ–≤–Ω—è–º–∏ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è
                                 –∏ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è–º–∏, –∏–ª–∏ None –ø—Ä–∏ –ø–æ–ª–Ω–æ–º –ø—Ä–æ–≤–∞–ª–µ.
    """

    # –ü–æ—Å–ª–µ–¥–Ω—è—è –æ—à–∏–±–∫–∞
    last_exception = None

    # –î–ª—è –∫–∞–∂–¥–æ–π –ø–æ–ø—ã—Ç–∫–∏
    for attempt in range(1, MAX_ATTEMPTS + 1):
        logger.info(f"–ü–æ–ø—ã—Ç–∫–∞ {attempt}/{MAX_ATTEMPTS} –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –∏–∑ {text_type}")

        try:
            # –ü–æ–ª—É—á–∞–µ–º LLM —Å —É–≤–µ–ª–∏—á–∏–≤–∞—é—â–µ–π—Å—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–æ–π
            structured_llm = get_structured_llm(
                pydantic_model=EducationList, attempt_number=attempt
            )

            # –§–æ—Ä–º–∏—Ä—É–µ–º –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞
            prompt_input = {"text": text.strip(), "text_type": text_type}

            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
            messages = await extract_main_edu_full_prompt.ainvoke(
                prompt_input
            )

            # –í—ã–ø–æ–ª–Ω—è–µ–º –≤—ã–∑–æ–≤ –º–æ–¥–µ–ª–∏
            response = await structured_llm.ainvoke(messages)

            logger.info(
                f"–£—Å–ø–µ—à–Ω–æ –∏–∑–≤–ª–µ—á–µ–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–∏ –ø–æ—Å–ª–µ {attempt} –ø–æ–ø—ã—Ç–∫–∏"
            )
            return response

        except Exception as e:
            last_exception = e
            logger.warning(
                f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ {attempt} –∏–∑–≤–ª–µ—á—å –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∏–∑ {text_type}: {str(e)}",
            )
            
            if attempt == MAX_ATTEMPTS:
                break

    # –í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –ø—Ä–æ–≤–∞–ª–∏–ª–∏—Å—å
    logger.error(
        f"–í—Å–µ {MAX_ATTEMPTS} –ø–æ–ø—ã—Ç–æ–∫ –∏–∑–≤–ª–µ—á—å –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∏–∑ {text_type} –ø—Ä–æ–≤–∞–ª–∏–ª–∏—Å—å: {str(last_exception)}",
        exc_info=True,
    )

    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Å–æ–≥–ª–∞—Å–Ω–æ –ø—Ä–∞–≤–∏–ª–∞–º
    return None


# === –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫ ===
if __name__ == "__main__":
    # –ü—Ä–∏–º–µ—Ä—ã —Ç–µ–∫—Å—Ç–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    TEST_CASES = [
        {
            "text": (
                "–¢—Ä–µ–±—É–µ—Ç—Å—è –≤—ã—Å—à–µ–µ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤ –æ–±–ª–∞—Å—Ç–∏ IT –∏–ª–∏ —ç–∫–æ–Ω–æ–º–∏–∫–∏. "
                "–ë—É–¥–µ—Ç –ø–ª—é—Å–æ–º –∑–Ω–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –±—É—Ö–≥–∞–ª—Ç–µ—Ä–∏–∏."
            ),
            "text_type": "vacancy",
        },
        {
            "text": (
                "–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ: —Å—Ä–µ–¥–Ω–µ–µ-—Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ, —Ç–µ—Ö–Ω–∏–∫—É–º, —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å ‚Äî –ª–æ–≥–∏—Å—Ç–∏–∫–∞. "
                "–¢–∞–∫–∂–µ –ø—Ä–æ—Ö–æ–¥–∏–ª –∫—É—Ä—Å—ã –ø–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é —Ü–µ–ø–æ—á–∫–∞–º–∏ –ø–æ—Å—Ç–∞–≤–æ–∫."
            ),
            "text_type": "resume",
        },
        {
            "text": "–ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ. –ì–æ—Ç–æ–≤—ã –æ–±—É—á–∏—Ç—å.",
            "text_type": "vacancy",
        },
        {"text": "", "text_type": "resume"},
    ]

    async def run_tests():
        print("\nüöÄ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ extract_main_edu_llm...\n")
        for i, case in enumerate(TEST_CASES, 1):
            print(f"--- –¢–µ—Å—Ç {i} | –¢–∏–ø: {case['text_type']} ---")
            print("–í—Ö–æ–¥–Ω–æ–π —Ç–µ–∫—Å—Ç:", repr(case["text"]))
            result = await extract_main_edu_llm(case["text"], case["text_type"])
            print("–†–µ–∑—É–ª—å—Ç–∞—Ç:")
            print(result.model_dump_json(indent=2))
            print("\n" + "-" * 60 + "\n")
            await asyncio.sleep(1)  # –ß—Ç–æ–±—ã –Ω–µ —Å–ø–∞–º–∏—Ç—å API

    # –ó–∞–ø—É—Å–∫ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
    try:
        asyncio.run(run_tests())
    except KeyboardInterrupt:
        print("\n‚ùå –¢–µ—Å—Ç—ã –ø—Ä–µ—Ä–≤–∞–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.")
        sys.exit(0)
    except Exception as e:
        print(f"\nüí• –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Ç–µ—Å—Ç–æ–≤: {e}")
        sys.exit(1)
