"""
–§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –∫—É—Ä—Å–æ–≤ –∏–∑ —Ä–µ–∑—é–º–µ —Å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –≤—ã–≤–æ–¥–æ–º
—Å –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã
"""

import asyncio
import sys
from typing import Optional

from langchain_core.messages import BaseMessage

from ....utils.create_llm_with_retries import get_structured_llm
from ....utils.logger import setup_logger
from ..prompts.extract_courses.extract_course_prompt_builder import (
    extract_course_full_prompt,
)
from ..pydantic_models.extract_courses import CourseList

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
logger = setup_logger(__name__)

# –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫
MAX_ATTEMPTS = 10


async def extract_course_llm(text: str) -> Optional[CourseList]:
    """
    –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –∏–∑–≤–ª–µ–∫–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫—É—Ä—Å–∞—Ö –∏–∑ —Ç–µ–∫—Å—Ç–∞ (—Ä–µ–∑—é–º–µ –∏–ª–∏ –≤–∞–∫–∞–Ω—Å–∏–∏)
    —Å –ø–æ–º–æ—â—å—é LLM –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞.

    –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –º–æ–¥–µ–ª–∏ –ø–ª–∞–≤–Ω–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è —Å –∫–∞–∂–¥–æ–π –ø–æ–ø—ã—Ç–∫–æ–π, —á—Ç–æ–±—ã –ø–æ–≤—ã—Å–∏—Ç—å
    –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑-–∑–∞ "–≥—Ä—è–∑–Ω—ã—Ö" —Å–∏–º–≤–æ–ª–æ–≤).

    Args:
        text (str): –¢–µ–∫—Å—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.

    Returns:
        Optional[CourseList]: –û–±—ä–µ–∫—Ç —Å –ø–æ–ª–µ–º `course_list`, —Å–æ–¥–µ—Ä–∂–∞—â–∏–º –∏–∑–≤–ª–µ—á—ë–Ω–Ω—ã–µ –∫—É—Ä—Å—ã.
                              –ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö –∏–ª–∏ –ø—É—Å—Ç–æ–º —Ç–µ–∫—Å—Ç–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è `CourseList(course_list=[])`.
    """

    # –ü–æ—Å–ª–µ–¥–Ω—è—è –æ—à–∏–±–∫–∞
    last_exception = None

    # –î–ª—è –∫–∞–∂–¥–æ–π –ø–æ–ø—ã—Ç–∫–∏
    for attempt in range(1, MAX_ATTEMPTS + 1):
        logger.info(f"–ü–æ–ø—ã—Ç–∫–∞ {attempt}/{MAX_ATTEMPTS} –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∫—É—Ä—Å–æ–≤")

        try:
            # –ü–æ–ª—É—á–∞–µ–º LLM —Å —É–≤–µ–ª–∏—á–∏–≤–∞—é—â–µ–π—Å—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–æ–π
            structured_llm = get_structured_llm(
                pydantic_model=CourseList, attempt_number=attempt
            )

            # –§–æ—Ä–º–∏—Ä—É–µ–º –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞
            prompt_input = {"text": text.strip()}

            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è (—Å–∏—Å—Ç–µ–º–Ω—ã–π + few-shot + –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π)
            messages: list[BaseMessage] = await extract_course_full_prompt.ainvoke(
                prompt_input
            )

            # –í—ã–ø–æ–ª–Ω—è–µ–º –≤—ã–∑–æ–≤ –º–æ–¥–µ–ª–∏
            response: CourseList = await structured_llm.ainvoke(messages)

            logger.info(f"–£—Å–ø–µ—à–Ω–æ –∏–∑–≤–ª–µ—á–µ–Ω—ã –∫—É—Ä—Å—ã –ø–æ—Å–ª–µ {attempt} –ø–æ–ø—ã—Ç–∫–∏")
            return response

        except Exception as e:
            last_exception = e
            logger.warning(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ {attempt} –∏–∑–≤–ª–µ—á—å –∫—É—Ä—Å—ã: {str(e)}")

            if attempt == MAX_ATTEMPTS:
                break

    # –í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –ø—Ä–æ–≤–∞–ª–∏–ª–∏—Å—å
    logger.error(
        f"–í—Å–µ {MAX_ATTEMPTS} –ø–æ–ø—ã—Ç–æ–∫ –∏–∑–≤–ª–µ—á—å –∫—É—Ä—Å—ã –ø—Ä–æ–≤–∞–ª–∏–ª–∏—Å—å: {str(last_exception)}",
        exc_info=True,
    )

    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ –∫—É—Ä—Å–æ–≤ –ø—Ä–∏ –ø–æ–ª–Ω–æ–º –ø—Ä–æ–≤–∞–ª–µ
    return None


# === –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫ ===
if __name__ == "__main__":
    TEST_CASES = [
        {
            "name": "–†–µ–∑—é–º–µ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –∫—É—Ä—Å–∞–º–∏",
            "text": """
                –ü—Ä–æ—Ö–æ–¥–∏–ª —Å–ª–µ–¥—É—é—â–∏–µ –∫—É—Ä—Å—ã:
                1. –ö—É—Ä—Å 'Python –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö' ‚Äî –æ–±—É—á–µ–Ω–∏–µ –≤–∫–ª—é—á–∞–ª–æ —Ä–∞–±–æ—Ç—É —Å Pandas, NumPy, –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é.
                2. '–û—Å–Ω–æ–≤—ã –º–∞—à–∏–Ω–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è' ‚Äî —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–µ–ª–µ–π –Ω–∞ scikit-learn, –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è, —Ä–µ–≥—Ä–µ—Å—Å–∏—è.
                3. 'Docker –∏ Kubernetes' ‚Äî —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π, –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤.
            """,
        },
        {
            "name": "–ö—É—Ä—Å—ã —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π",
            "text": """
                - –û–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ Stepik: '–í–≤–µ–¥–µ–Ω–∏–µ –≤ Git –∏ GitHub', –æ–ø–∏—Å–∞–Ω–∏–µ ‚Äî –æ—Å–Ω–æ–≤—ã –∫–æ–Ω—Ç—Ä–æ–ª—è –≤–µ—Ä—Å–∏–π.
                - Coursera: 'Deep Learning Specialization' –æ—Ç Andrew Ng ‚Äî –Ω–µ–π—Ä–æ—Å–µ—Ç–∏, backpropagation, CNN.
                - Skillbox: 'Data Analyst' ‚Äî SQL, Excel, Power BI, Python.
            """,
        },
        {
            "name": "–¢–µ–∫—Å—Ç –±–µ–∑ –∫—É—Ä—Å–æ–≤",
            "text": "–†–∞–±–æ—Ç–∞–ª –≤ IT 7 –ª–µ—Ç, –≤—ã—Å—à–µ–µ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ, –æ–ø—ã—Ç –≤ DevOps, –±–µ–∑ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –∫—É—Ä—Å–æ–≤.",
        },
        {
            "name": "–ü—É—Å—Ç–æ–π —Ç–µ–∫—Å—Ç",
            "text": "",
        },
        {
            "name": "–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –∫—É—Ä—Å–∞–º –≤–æ –≤–∞–∫–∞–Ω—Å–∏–∏",
            "text": """
                –¢—Ä–µ–±—É—é—Ç—Å—è –∫–∞–Ω–¥–∏–¥–∞—Ç—ã —Å –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ–º –∫—É—Ä—Å–æ–≤:
                - –ø–æ –∫–∏–±–µ—Ä–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, CISSP, CEH)
                - –ø–æ –æ–±–ª–∞—á–Ω—ã–º —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è–º (AWS –∏–ª–∏ Azure)
                - –ø–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é –ø—Ä–æ–µ–∫—Ç–∞–º–∏ (–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ PMP –∏–ª–∏ Scrum-–∫—É—Ä—Å—ã)
            """,
        },
    ]

    async def run_tests():
        print("\nüß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –¥–ª—è extract_course_llm\n")
        for i, case in enumerate(TEST_CASES, 1):
            print(f"--- –¢–ï–°–¢ {i}: {case['name']} ---")
            print("–í—Ö–æ–¥–Ω–æ–π —Ç–µ–∫—Å—Ç:", repr(case["text"]))

            try:
                result = await extract_course_llm(case["text"])
                if result is None:
                    print("‚ùå –†–µ–∑—É–ª—å—Ç–∞—Ç: None")
                else:
                    print("‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç:")
                    print(result.model_dump_json(indent=2))
            except Exception as e:
                print(f"üí• –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ —Ç–µ—Å—Ç–∞: {e}")

            print("\n" + "‚îÄ" * 80 + "\n")
            await asyncio.sleep(1)  # –ß—Ç–æ–±—ã –Ω–µ —Å–ø–∞–º–∏—Ç—å LLM

    # –ó–∞–ø—É—Å–∫
    try:
        asyncio.run(run_tests())
    except KeyboardInterrupt:
        print("\n‚õî –¢–µ—Å—Ç—ã –ø—Ä–µ—Ä–≤–∞–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.")
        sys.exit(0)
    except Exception as e:
        print(f"\nüí• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
        sys.exit(1)
